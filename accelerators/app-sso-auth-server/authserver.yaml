#@ load("@ytt:data", "data")

#@ def array_contains(idpType):
#@   for i in data.values.idpTypes:
#@     if i == idpType:
#@       return True
#@     end
#@   end
#@   return False
#@ end
---
apiVersion: sso.apps.tanzu.vmware.com/v1alpha1
kind: AuthServer
metadata:
  name: #@ data.values.artifactId
  namespace: #@ data.values.namespace
  labels:
    name: #@ data.values.artifactId
  annotations:
    sso.apps.tanzu.vmware.com/allow-client-namespaces: #@ ",".join(data.values.allowedNamespaces)
    #@ if data.values.allowHttpIssuer:
    sso.apps.tanzu.vmware.com/allow-unsafe-issuer-uri: ""
    #@ end
    #@ if array_contains("internal"):
    sso.apps.tanzu.vmware.com/allow-unsafe-identity-provider: ""
    #@ end
spec:
  replicas: 1
  #@ if data.values.allowHttpIssuer:
  issuerURI: #@ "http://{}".format(data.values.authserverFqdn)
  #@ else:
  issuerURI: #@ "https://{}".format(data.values.authserverFqdn)
  #@ end
  tokenSignature:
    signAndVerifyKeyRef:
      name: #@ "{}-signing-key".format(data.values.artifactId)
  identityProviders:
    #@ if array_contains("internal"):
    - name: "internal"
      internalUnsafe:
        users:
          - username: "user"
            password: "$2a$10$201z9o/tHlocFsHFTo0plukh03ApBYe4dRiXcqeyRQH6CNNtS8jWK"
    #@ end
    #@ if array_contains("ldap"):
    - name: ldap
      ldap:
        server:
          scheme: #@ data.values.ldapScheme
          host: #@ data.values.ldapHost
          port: #@ data.values.ldapPort
          base: #@ data.values.ldapBaseDn
        bind:
          dn: #@ data.values.bindDn
          passwordRef:
            name: ldap-password
        user:
          searchFilter: #@ data.values.userSearchFilterAttribute + "={0}"
          searchBase: #@ data.values.userSearchBaseDn
        group:
          searchFilter: #@ data.values.groupSearchFilterAttribute + "={0}"
          searchBase: #@ data.values.groupSearchBaseDn
          searchSubTree: #@ data.values.groupSearchSubTree
          searchDepth: #@ data.values.groupSearchDepth
          roleAttribute: #@ data.values.groupRoleAttr
    #@ end
    #@ if array_contains("oidc"):
    - name: oidc
      openID:
        issuerURI: #@ data.values.issuerUri
        authorizationUri: #@ data.values.authorizationUri
        tokenUri: #@ data.values.tokenUri
        jwksUri: #@ data.values.jwksUri
        clientID: #@ data.values.clientId
        clientSecretRef:
          name: #@ "{}-oidc-client-secret".format(data.values.artifactId)
        scopes: #@ data.values.scopes
        claimMappings:
          roles: #@ data.values.rolesClaimMapping
    #@ end
    #@ if array_contains("saml"):
    - name: my-saml-provider
      saml:
        metadataURI: #@ data.values.metadataUri
        #@ if data.values.configureClaimMappings:
        claimMappings:
          #@ if data.values.rolesClaimMapping:
          roles: #@ data.values.rolesClaimMapping
          #@ end
          #@ if data.values.givenNameClaimMapping:
          givenName: #@ data.values.givenNameClaimMapping
          #@ end
          #@ if data.values.familyNameClaimMapping:
          familyName: #@ data.values.familyNameClaimMapping
          #@ end
          #@ if data.values.emailClaimMapping:
          emailAddress: #@ data.values.emailClaimMapping
          #@ end
        #@ end
    #@ end
#@ if array_contains("ldap"):
---
apiVersion: v1
kind: Secret
metadata:
  name: ldap-password
  namespace: #@ data.values.namespace
stringData:
  password: #@ data.values.bindUserPassword
#@ end
#@ if array_contains("oidc"):
---
apiVersion: v1
kind: Secret
metadata:
  name: #@ "{}-oidc-client-secret".format(data.values.artifactId)
  namespace: #@ data.values.namespace
stringData:
  clientSecret: #@ data.values.clientSecret
#@ end
---
apiVersion: secretgen.k14s.io/v1alpha1
kind: RSAKey
metadata:
  name: #@ "{}-signing-key".format(data.values.artifactId)
  namespace: #@ data.values.namespace
spec:
  secretTemplate:
    type: Opaque
    stringData:
      key.pem: $(privateKey)
      pub.pem: $(publicKey)
---
apiVersion: v1
kind: Service
metadata:
  name: #@ data.values.artifactId
  namespace: #@ data.values.namespace
spec:
  selector:
    app.kubernetes.io/part-of: #@ data.values.artifactId
    app.kubernetes.io/component: authorization-server
  ports:
    - port: 80
      targetPort: 8080
---
apiVersion: projectcontour.io/v1
kind: HTTPProxy
metadata:
  name: #@ data.values.artifactId
  namespace: #@ data.values.namespace
spec:
  virtualhost:
    fqdn: #@ data.values.authserverFqdn
    #@ if not data.values.allowHttpIssuer:
    tls:
      secretName: #@ data.values.tlsSecretName
    #@ end
  routes:
    - conditions:
        - prefix: /
      services:
        - name: #@ data.values.artifactId
          port: 80